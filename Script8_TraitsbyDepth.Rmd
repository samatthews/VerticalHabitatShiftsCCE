---
title: "Script8_TraitsbyDepth"
output: html_document
date: "2022-10-20"
---

```{r load libraries}
library(phyloseq)
library(vegan)
library(ggplot2)
library(dplyr)
library(tidyr)
#library(clustsig) not available anymore
library(ggdendro)
library(gridExtra)
library(stringr)
library(dendextend)
library(Biostrings)
library(insect)
library(ape)
library(seqinr)
library(decontam)
library(lmodel2)
library(mgcv)
library(goeveg)
library(metagMisc)
library(magrittr)
library(ggpubr)
library(RColorBrewer)
library(readxl)
library(rcompanion)
library(car)
library(nlme)
library(lme4)
library(MuMIn)
library(reshape2)
library(gt)
```

```{r load data}
load("COIdataforASM.rdat") #this loads calculated MDO, a rarified version of the dataset, the dataset that the MDO was calculated on, and the epipelagic MDO 
load("ZHANdataforASM.rdat")#this loads calculated MDO, a rarified version of the dataset, the dataset that the MDO was calculated on, and the epipelagic MDO 
load("tables_bothmarkers_absentspeciesremoved_COIstopcodonsremoved_traitsadded_withDVM.Rdat") #this overwrites the objects "ZHAN" and "COI" with the updated versions that have been filtered to remove pseudogenes, and have migratory classification added, and have the taxonomy of species not occuring the N. Pacific removed, and have empty taxa removed
```

### ALL TRAITS COI

#DIET
```{r}
Dietplot <- COI

#relable empty diet slots as unkown
tax_table(Dietplot)[,15][tax_table(Dietplot)[,15]=="NA"] <- NA
tax_table(Dietplot)[,15][is.na(tax_table(Dietplot)[,15])] <- "Unknown"

#remove unknowns
nounknowndiets <- subset_taxa(Dietplot, Diet != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowndiets) <- tax_table(nounknowndiets)[,c("Diet", "FeedingBehavior")]
Dietplot_corrmat <- tax_glom(nounknowndiets)

#rename the gloms to their diet mode
taxa_names(Dietplot_corrmat) <- tax_table(Dietplot_corrmat)[,c("Diet")]
dietsampledat <- data.frame(sample_data(Dietplot_corrmat))
dietdat <- data.frame(otu_table(transform_sample_counts(Dietplot_corrmat, function(x) x / sum(x) )))
diet <- merge(dietsampledat, dietdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
diet$Carnivore_scaled <- diet$Carnivore
diet$Carnivore_scaled[diet$Cycle == "4"] <- (diet$Carnivore[diet$Cycle == "4"])/max(diet$Carnivore) #[diet$Cycle == "4"]
diet$Carnivore_scaled[diet$Cycle == "3"] <- (diet$Carnivore[diet$Cycle == "3"])/max(diet$Carnivore) #[diet$Cycle == "3"]
diet$Carnivore_scaled[diet$Cycle == "2"] <- (diet$Carnivore[diet$Cycle == "2"])/max(diet$Carnivore) #[diet$Cycle == "2"]
diet$Carnivore_scaled[diet$Cycle == "1"] <- (diet$Carnivore[diet$Cycle == "1"])/max(diet$Carnivore) #[diet$Cycle == "1"]
diet$Herbivore_scaled <- diet$Herbivore
diet$Herbivore_scaled[diet$Cycle == "4"] <- (diet$Herbivore[diet$Cycle == "4"])/max(diet$Herbivore) #[diet$Cycle == "4"]
diet$Herbivore_scaled[diet$Cycle == "3"] <- (diet$Herbivore[diet$Cycle == "3"])/max(diet$Herbivore) #[diet$Cycle == "3"]
diet$Herbivore_scaled[diet$Cycle == "2"] <- (diet$Herbivore[diet$Cycle == "2"])/max(diet$Herbivore) #[diet$Cycle == "2"]
diet$Herbivore_scaled[diet$Cycle == "1"] <- (diet$Herbivore[diet$Cycle == "1"])/max(diet$Herbivore) #[diet$Cycle == "1"]
diet$Omnivore_scaled <- diet$Omnivore
diet$Omnivore_scaled[diet$Cycle == "4"] <- (diet$Omnivore[diet$Cycle == "4"])/max(diet$Omnivore) #[diet$Cycle == "4"]
diet$Omnivore_scaled[diet$Cycle == "3"] <- (diet$Omnivore[diet$Cycle == "3"])/max(diet$Omnivore) #[diet$Cycle == "3"]
diet$Omnivore_scaled[diet$Cycle == "2"] <- (diet$Omnivore[diet$Cycle == "2"])/max(diet$Omnivore) #[diet$Cycle == "2"]
diet$Omnivore_scaled[diet$Cycle == "1"] <- (diet$Omnivore[diet$Cycle == "1"])/max(diet$Omnivore) #[diet$Cycle == "1"]


diet_clean_matrix <- diet[,c("Row.names", "Omnivore", "Herbivore", "Carnivore", "Omnivore_scaled", "Herbivore_scaled", "Carnivore_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


```

```{r reformat}

#melt together
melteddiet <- melt(diet_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
melteddiet$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, melteddiet)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c("Omnivore_scaled", "Herbivore_scaled", "Carnivore_scaled", "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c("Carnivore_scaled", "Herbivore_scaled", "Omnivore_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

```

```{r plot pretty diet}

p <- ggplot(data = meltedtogether) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, size = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
  scale_size_manual(values = c(0.8, 0.8, 0.4, 0.4, 0.4), guide = "none") + 
  scale_shape_manual(values =c(16, 16, 16, NA, NA),
                     breaks=c('Carnivore_scaled', 'Herbivore_scaled', 'Omnivore_scaled', 'Fluor_scaled', 'LightExt_scaled'),
                      labels = c("Carnivores", "Herbivores", "Omnivores", "Fluorescence", "Light Exctinction"),
                     guide = "none") + #, guide = "none"
  scale_colour_manual(values = c( "#F8766D", "#619CFF",  "#C77CFF", "#00BA38", "grey1"),
                      breaks=c('Carnivore_scaled', 'Herbivore_scaled', 'Omnivore_scaled', 'Fluor_scaled', 'LightExt_scaled'),
                      labels = c("Carnivores", "Herbivores", "Omnivores", expression(paste("Chlorophyll-",  "\u03B1", sep = "")), "Light Exctinction"),
                      name = "Environmental \nVariable \nDietary Trait") +
  guides(color = guide_legend(override.aes = list(
                         linetype = c("solid", "solid", "solid", "solid", "solid"),
                         shape = c(16, 16, 16, NA,NA)))) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p

meltedtogether_taxa <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_Diet <- ggplot(data = meltedtogether_taxa) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
    scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Diet") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "Diet") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
  scale_size_manual(values = c(0.8, 0.8, 0.4, 0.4, 0.4), guide = "none") + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_Diet



library(ggh4x) #explore this later if there's time

gp <- ggplotGrob(p)

# optional: take a look at the grob object's layout
gtable::gtable_show_layout(gp)

# get gtable columns corresponding to the facets (5 & 9, in this case)
facet.columns <- gp$layout$l[grepl("panel", gp$layout$name)]
break.columns <- gp$layout$l[grepl("strip", gp$layout$name)]

#facet.columns <- c(5,7,9,11,13,15,17,19)

# get the number of unique x-axis values per facet (1 & 3, in this case)
x.var <- sapply(ggplot_build(p)$layout$panel_scales_x,
                function(l) length(l$range$range))
x.var <- c(1,3,1,3,1,3,1,3)
x.var <- c(1,1,3,3,1,1,3,3,1,1,3,3,1,1,3,3) #change sizes of panels 

b.var <- c(1,1,2,1,2,1,2,1,1,1) #change sizes of breaks

# change the relative widths of the facet columns based on
# how many unique x-axis values are in each facet
gp$widths[facet.columns] <- gp$widths[facet.columns] * x.var
#gp$widths[break.columns] <- gp$widths[break.columns] * b.var

# plot result

grid::grid.draw(gp)

#gt = ggplot_gtable(ggplot_build(gp))
gt <- gp
gt$widths[8] = 3*gt$widths[8]
gt$widths[12] = 3*gt$widths[12]
gt$widths[16] = 3*gt$widths[16]
grid::grid.draw(gt)


pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyDietCOI.pdf", height =4.8, width = 8.5)
grid::grid.draw(gt)
dev.off()

jpeg(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyDietCOI.jpeg", height =4.8, width = 8.5, unit = "in", quality = 100, res = 300)
grid::grid.draw(gt)
dev.off()

table(tax_table(COI)[tax_table(COI)[,15] == "Carnivore",5]) #what taxa make up the carnivores?
table(tax_table(COI)[tax_table(COI)[,15] == "Herbivore",5]) #what taxa make up the herbivores?
```

```{r play with diet groups (who are each diet), write table}

plot_bar_width_double_withindiet <- function (physeq, x = "Sample", y = "Abundance", 
  title = NULL, facet_grid = NULL, w = "binwidth") {
  mdf = psmelt(physeq)
  disp1 <- max(mdf$Abundance)*1
#  mdf$Abundance[mdf$Diel == "day"] <- mdf$Abundance[mdf$Diel == "day"]*-1
  p <- ggplot(mdf, aes(x = depthmean, y = Abundance, width = binwidth*.9, fill = Order)) + 
    geom_bar(stat = "identity", position ="stack") + #ylim(-disp1, disp1) +
 # scale_y_continuous(breaks = scales::pretty_breaks(n = 4), limits = c(0, disp1)) + 
    theme(axis.text.x = element_text(angle = 90),
          axis.text.y = element_text(angle = 90)) +
 #   scale_color_manual(values = c("lightgrey", "black")) +
    coord_flip() + 
    scale_x_reverse() +
    labs(x = "Depth", y = "Relative Abundance (Proportion)") +
  geom_hline(yintercept = 0, size = 0.2)
  if (!is.null(facet_grid)) {
    p <- p + facet_grid(facet_grid)
  }
  if (!is.null(title)) {
    p <- p + ggtitle(title)
  }
  return(p)
}


p <- plot_bar_width_double_withindiet(transform_sample_counts(subset_taxa(Dietplot, Diet == "Omnivore"), function(x) x / sum(x) ), x = "depthmean") + 
  facet_grid(Diel~Cycle) + 
  theme_bw() +
  theme(strip.text = element_text(size=8),
        plot.subtitle = element_text(size = 9)) + 
 # theme(plot.title = element_text(size=7), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
 # xlab("Rarified Read Count") 
   ggtitle("Omnivores")
p

p <- plot_bar_width_double_withindiet(transform_sample_counts(subset_taxa(Dietplot, Diet == "Carnivore"), function(x) x / sum(x) ), x = "depthmean") + 
  facet_grid(Diel~Cycle) + 
  theme_bw() +
  theme(strip.text = element_text(size=8),
        plot.subtitle = element_text(size = 9)) + 
 # theme(plot.title = element_text(size=7), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
 # xlab("Rarified Read Count") 
   ggtitle("Carnivores")
p


p <- plot_bar_width_double_withindiet(transform_sample_counts(subset_taxa(Dietplot, Diet == "Herbivore"), function(x) x / sum(x) ), x = "depthmean") + 
  facet_grid(Diel~Cycle) + 
  theme_bw() +
  theme(strip.text = element_text(size=8),
        plot.subtitle = element_text(size = 9)) + 
 # theme(plot.title = element_text(size=7), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
 # xlab("Rarified Read Count") 
   ggtitle("Herbivores")
p

dplyr::bind_rows(
  data.frame(tax_table(Dietplot)) %>%
  group_by(Diet, Class) %>% 
  dplyr::summarize(
      OTUs = n(),
      .groups = "drop_last"),
data.frame(tax_table(Dietplot)) %>%
  group_by(Diet, Class, Family) %>% 
  dplyr::summarize(
      OTUs = n(),
      .groups = "drop")) %>%
  arrange(Diet, Class, Family, OTUs) %>%
  gt(rowname_col = NA, groupname_col = "Diet") %>% #rowname_col = "Class", groupname_col = "Diet"
  tab_stubhead(label = "Diet") %>%
  tab_header(
    title = "Diversity within Diet Type",
    subtitle = "Identity and Number of OTUs exhibiting each diet type"
  )%>%
  gtsave(filename = "OTUsbydiet_classfam.docx")



data.frame(tax_table(Dietplot)) %>%
  group_by(Diet, Class, Family) %>% 
  dplyr::summarize(
      OTUs = n(),
      .groups = "drop") %>%
  arrange(Diet, Class, Family, OTUs) %>%
  gt(rowname_col = "Class", groupname_col = "Diet") %>%
  summary_rows(groups = TRUE,
    columns = OTUs,
    fns = list(
      total = "sum")) %>% 
    tab_style(style = cell_text(align = "left", indent = px(80)),
        locations = cells_stub()) %>% 
  tab_header(title = "Diversity within Diet Type",
    subtitle = "Number of OTUs within each Class and Family")%>%
  gtsave(filename = "OTUsbydiet.docx")


data.frame(tax_table(Dietplot)) %>%
  group_by(Diet, Class) %>% 
  dplyr::summarize(
      OTUs = n(),
      .groups = "drop") %>%
  arrange(Diet, Class, OTUs) %>%
  gt(rowname_col = "Class", groupname_col = "Diet") %>%
  summary_rows(groups = TRUE,
    columns = OTUs,
    fns = list(
      total = "sum")) %>% 
    tab_style(style = cell_text(align = "left", indent = px(80)),
        locations = cells_stub()) %>% 
  tab_header(title = "Diversity within Diet Type",
    subtitle = "Number of OTUs within each Class and Family")%>%
  gtsave(filename = "OTUsbydiet_Class.docx")

```

#FEEDING BEHAVIOR
```{r feeding behavior}
traitplot <- COI

#relable empty diet slots as unkown
tax_table(traitplot)[,17][tax_table(traitplot)[,17]==""] <- "Unknown"

#remove unknowns
nounknowntrait <- subset_taxa(traitplot, FeedingBehavior != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("FeedingBehavior", "CalculatedDVM")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "FeedingBehavior")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("FeedingBehavior")]
traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$Suspension_scaled <- trait$Suspension
trait$Suspension_scaled[trait$Cycle == "4"] <- (trait$Suspension[trait$Cycle == "4"])/max(trait$Suspension) #[diet$Cycle == "4"]
trait$Suspension_scaled[trait$Cycle == "3"] <- (trait$Suspension[trait$Cycle == "3"])/max(trait$Suspension) #[diet$Cycle == "3"]
trait$Suspension_scaled[trait$Cycle == "2"] <- (trait$Suspension[trait$Cycle == "2"])/max(trait$Suspension) #[diet$Cycle == "2"]
trait$Suspension_scaled[trait$Cycle == "1"] <- (trait$Suspension[trait$Cycle == "1"])/max(trait$Suspension) #[diet$Cycle == "1"]
trait$Ambush_scaled <- trait$Ambush
trait$Ambush_scaled[trait$Cycle == "4"] <- (trait$Ambush[trait$Cycle == "4"])/max(trait$Ambush) #[diet$Cycle == "4"]
trait$Ambush_scaled[trait$Cycle == "3"] <- (trait$Ambush[trait$Cycle == "3"])/max(trait$Ambush) #[diet$Cycle == "3"]
trait$Ambush_scaled[trait$Cycle == "2"] <- (trait$Ambush[trait$Cycle == "2"])/max(trait$Ambush) #[diet$Cycle == "2"]
trait$Ambush_scaled[trait$Cycle == "1"] <- (trait$Ambush[trait$Cycle == "1"])/max(trait$Ambush) #[diet$Cycle == "1"]
trait$Cruise_scaled <- trait$Cruise
trait$Cruise_scaled[trait$Cycle == "4"] <- (trait$Cruise[trait$Cycle == "4"])/max(trait$Cruise) #[diet$Cycle == "4"]
trait$Cruise_scaled[trait$Cycle == "3"] <- (trait$Cruise[trait$Cycle == "3"])/max(trait$Cruise) #[diet$Cycle == "3"]
trait$Cruise_scaled[trait$Cycle == "2"] <- (trait$Cruise[trait$Cycle == "2"])/max(trait$Cruise) #[diet$Cycle == "2"]
trait$Cruise_scaled[trait$Cycle == "1"] <- (trait$Cruise[trait$Cycle == "1"])/max(trait$Cruise) #[diet$Cycle == "1"]
trait$Parasitoid_scaled <- trait$Parasitoid
trait$Parasitoid_scaled[trait$Cycle == "4"] <- (trait$Parasitoid[trait$Cycle == "4"])/max(trait$Parasitoid) #[diet$Cycle == "4"]
trait$Parasitoid_scaled[trait$Cycle == "3"] <- (trait$Parasitoid[trait$Cycle == "3"])/max(trait$Parasitoid) #[diet$Cycle == "3"]
trait$Parasitoid_scaled[trait$Cycle == "2"] <- (trait$Parasitoid[trait$Cycle == "2"])/max(trait$Parasitoid) #[diet$Cycle == "2"]
trait$Parasitoid_scaled[trait$Cycle == "1"] <- (trait$Parasitoid[trait$Cycle == "1"])/max(trait$Parasitoid) #[diet$Cycle == "1"]


trait_clean_matrix <- trait[,c("Row.names", "Suspension", "Ambush", "Cruise", "Parasitoid", "Suspension_scaled", "Ambush_scaled", "Cruise_scaled", "Parasitoid_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c("Suspension_scaled", "Ambush_scaled", "Cruise_scaled", "Parasitoid_scaled", "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c("Suspension_scaled", "Ambush_scaled", "Cruise_scaled", "Parasitoid_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_feeding <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Feeding Behavior") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "Feeding Behavior") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_feeding



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyFeedBehaviorCOI.pdf", height =4.8, width = 8.5)
p_feeding
dev.off()


```

#SPAWNING
```{r spawning}
traitplot <- COI

#relable empty diet slots as unkown
tax_table(traitplot)[,18][tax_table(traitplot)[,18]==""] <- "Unknown"

#remove unknowns
nounknowntrait <- subset_taxa(traitplot, Spawning != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("Spawning", "CalculatedDVM")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "Spawning")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("Spawning")]
taxa_names(Traitplot_corrmat)

traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$Broadcast_scaled <- trait$Broadcast
trait$Broadcast_scaled[trait$Cycle == "4"] <- (trait$Broadcast[trait$Cycle == "4"])/max(trait$Broadcast) #[diet$Cycle == "4"]
trait$Broadcast_scaled[trait$Cycle == "3"] <- (trait$Broadcast[trait$Cycle == "3"])/max(trait$Broadcast) #[diet$Cycle == "3"]
trait$Broadcast_scaled[trait$Cycle == "2"] <- (trait$Broadcast[trait$Cycle == "2"])/max(trait$Broadcast) #[diet$Cycle == "2"]
trait$Broadcast_scaled[trait$Cycle == "1"] <- (trait$Broadcast[trait$Cycle == "1"])/max(trait$Broadcast) #[diet$Cycle == "1"]
trait$Brooding_scaled <- trait$Brooding
trait$Brooding_scaled[trait$Cycle == "4"] <- (trait$Brooding[trait$Cycle == "4"])/max(trait$Brooding) #[diet$Cycle == "4"]
trait$Brooding_scaled[trait$Cycle == "3"] <- (trait$Brooding[trait$Cycle == "3"])/max(trait$Brooding) #[diet$Cycle == "3"]
trait$Brooding_scaled[trait$Cycle == "2"] <- (trait$Brooding[trait$Cycle == "2"])/max(trait$Brooding) #[diet$Cycle == "2"]
trait$Brooding_scaled[trait$Cycle == "1"] <- (trait$Brooding[trait$Cycle == "1"])/max(trait$Brooding) #[diet$Cycle == "1"]


trait_clean_matrix <- trait[,c("Row.names", "Broadcast", "Brooding", "Broadcast_scaled", "Brooding_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c("Broadcast_scaled", "Brooding_scaled",  "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c("Broadcast_scaled", "Brooding_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_spawning <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Spawning Strategy") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "Spawning Strategy") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_spawning



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbySpawnCOI.pdf", height =4.8, width = 8.5)
p_spawning
dev.off()


```

#ASEXUAL REPRO
```{r asexual}
traitplot <- COI

#relable empty diet slots as unkown
tax_table(traitplot)[,19][tax_table(traitplot)[,19]==""] <- "Unknown"

#remove unknowns
nounknowntrait <- subset_taxa(traitplot, AsexualRepro != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("AsexualRepro", "CalculatedDVM")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "AsexualRepro")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("AsexualRepro")]
taxa_names(Traitplot_corrmat)
traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$No_scaled <- trait$No
trait$No_scaled[trait$Cycle == "4"] <- (trait$No[trait$Cycle == "4"])/max(trait$No) #[diet$Cycle == "4"]
trait$No_scaled[trait$Cycle == "3"] <- (trait$No[trait$Cycle == "3"])/max(trait$No) #[diet$Cycle == "3"]
trait$No_scaled[trait$Cycle == "2"] <- (trait$No[trait$Cycle == "2"])/max(trait$No) #[diet$Cycle == "2"]
trait$No_scaled[trait$Cycle == "1"] <- (trait$No[trait$Cycle == "1"])/max(trait$No) #[diet$Cycle == "1"]
trait$Yes_scaled <- trait$Yes
trait$Yes_scaled[trait$Cycle == "4"] <- (trait$Yes[trait$Cycle == "4"])/max(trait$Yes) #[diet$Cycle == "4"]
trait$Yes_scaled[trait$Cycle == "3"] <- (trait$Yes[trait$Cycle == "3"])/max(trait$Yes) #[diet$Cycle == "3"]
trait$Yes_scaled[trait$Cycle == "2"] <- (trait$Yes[trait$Cycle == "2"])/max(trait$Yes) #[diet$Cycle == "2"]
trait$Yes_scaled[trait$Cycle == "1"] <- (trait$Yes[trait$Cycle == "1"])/max(trait$Yes) #[diet$Cycle == "1"]



trait_clean_matrix <- trait[,c("Row.names", "No", "Yes", "No_scaled", "Yes_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c("No_scaled", "Yes_scaled",  "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c("No_scaled", "Yes_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_Asexual <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Presence of \nAsexual Reproduction") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "Presence of \nAsexual Reproduction") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_Asexual



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyAsexualReproCOI.pdf", height =4.8, width = 8.5)
p_Asexual
dev.off()


```

#CARBON 
```{r carbon}
traitplot <- COI

#relable empty diet slots as unkown
tax_table(traitplot)[,21][tax_table(traitplot)[,21]==""] <- "Unknown"

#remove unknowns
nounknowntrait <- subset_taxa(traitplot, Carbon != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("Carbon", "CalculatedDVM")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "Carbon")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("Carbon")]
taxa_names(Traitplot_corrmat)
traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$G_scaled <- trait$G
trait$G_scaled[trait$Cycle == "4"] <- (trait$G[trait$Cycle == "4"])/max(trait$G) #[diet$Cycle == "4"]
trait$G_scaled[trait$Cycle == "3"] <- (trait$G[trait$Cycle == "3"])/max(trait$G) #[diet$Cycle == "3"]
trait$G_scaled[trait$Cycle == "2"] <- (trait$G[trait$Cycle == "2"])/max(trait$G) #[diet$Cycle == "2"]
trait$G_scaled[trait$Cycle == "1"] <- (trait$G[trait$Cycle == "1"])/max(trait$G) #[diet$Cycle == "1"]
trait$I_scaled <- trait$I
trait$I_scaled[trait$Cycle == "4"] <- (trait$I[trait$Cycle == "4"])/max(trait$I) #[diet$Cycle == "4"]
trait$I_scaled[trait$Cycle == "3"] <- (trait$I[trait$Cycle == "3"])/max(trait$I) #[diet$Cycle == "3"]
trait$I_scaled[trait$Cycle == "2"] <- (trait$I[trait$Cycle == "2"])/max(trait$I) #[diet$Cycle == "2"]
trait$I_scaled[trait$Cycle == "1"] <- (trait$I[trait$Cycle == "1"])/max(trait$I) #[diet$Cycle == "1"]
trait$NG_scaled <- trait$NG
trait$NG_scaled[trait$Cycle == "4"] <- (trait$NG[trait$Cycle == "4"])/max(trait$NG) #[diet$Cycle == "4"]
trait$NG_scaled[trait$Cycle == "3"] <- (trait$NG[trait$Cycle == "3"])/max(trait$NG) #[diet$Cycle == "3"]
trait$NG_scaled[trait$Cycle == "2"] <- (trait$NG[trait$Cycle == "2"])/max(trait$NG) #[diet$Cycle == "2"]
trait$NG_scaled[trait$Cycle == "1"] <- (trait$NG[trait$Cycle == "1"])/max(trait$NG) #[diet$Cycle == "1"]



trait_clean_matrix <- trait[,c("Row.names", "G", "I", "NG", "G_scaled", "I_scaled", "NG_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c( "G_scaled", "I_scaled", "NG_scaled",  "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c( "G_scaled", "I_scaled", "NG_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_Carbon <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Composition") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "Composition") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_Carbon



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyCarbonCOI.pdf", height =4.8, width = 8.5)
p_Carbon
dev.off()


```

#TRANSPARENCY
```{r}
traitplot <- COI

#relable empty diet slots as unkown
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==""] <- "Unknown"
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==" 1"] <- "One"
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==" 2"] <- "Two"
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==" 3"] <- "Three"
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==" 4"] <- "Four"
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==" 5"] <- "Five"


#remove unknowns
nounknowntrait <- subset_taxa(traitplot, Transparency != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("Transparency", "CalculatedDVM")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "Transparency")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("Transparency")]
taxa_names(Traitplot_corrmat)
traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$One_scaled <- trait$One
trait$One_scaled[trait$Cycle == "4"] <- (trait$One[trait$Cycle == "4"])/max(trait$One) #[diet$Cycle == "4"]
trait$One_scaled[trait$Cycle == "3"] <- (trait$One[trait$Cycle == "3"])/max(trait$One) #[diet$Cycle == "3"]
trait$One_scaled[trait$Cycle == "2"] <- (trait$One[trait$Cycle == "2"])/max(trait$One) #[diet$Cycle == "2"]
trait$One_scaled[trait$Cycle == "1"] <- (trait$One[trait$Cycle == "1"])/max(trait$One) #[diet$Cycle == "1"]
trait$Two_scaled <- trait$Two
trait$Two_scaled[trait$Cycle == "4"] <- (trait$Two[trait$Cycle == "4"])/max(trait$Two) #[diet$Cycle == "4"]
trait$Two_scaled[trait$Cycle == "3"] <- (trait$Two[trait$Cycle == "3"])/max(trait$Two) #[diet$Cycle == "3"]
trait$Two_scaled[trait$Cycle == "2"] <- (trait$Two[trait$Cycle == "2"])/max(trait$Two) #[diet$Cycle == "2"]
trait$Two_scaled[trait$Cycle == "1"] <- (trait$Two[trait$Cycle == "1"])/max(trait$Two) #[diet$Cycle == "1"]
trait$Three_scaled <- trait$Three
trait$Three_scaled[trait$Cycle == "4"] <- (trait$Three[trait$Cycle == "4"])/max(trait$Three) #[diet$Cycle == "4"]
trait$Three_scaled[trait$Cycle == "3"] <- (trait$Three[trait$Cycle == "3"])/max(trait$Three) #[diet$Cycle == "3"]
trait$Three_scaled[trait$Cycle == "2"] <- (trait$Three[trait$Cycle == "2"])/max(trait$Three) #[diet$Cycle == "2"]
trait$Three_scaled[trait$Cycle == "1"] <- (trait$Three[trait$Cycle == "1"])/max(trait$Three) #[diet$Cycle == "1"]
trait$Four_scaled <- trait$Four
trait$Four_scaled[trait$Cycle == "4"] <- (trait$Four[trait$Cycle == "4"])/max(trait$Four) #[diet$Cycle == "4"]
trait$Four_scaled[trait$Cycle == "3"] <- (trait$Four[trait$Cycle == "3"])/max(trait$Four) #[diet$Cycle == "3"]
trait$Four_scaled[trait$Cycle == "2"] <- (trait$Four[trait$Cycle == "2"])/max(trait$Four) #[diet$Cycle == "2"]
trait$Four_scaled[trait$Cycle == "1"] <- (trait$Four[trait$Cycle == "1"])/max(trait$Four) #[diet$Cycle == "1"]
trait$Five_scaled <- trait$Five
trait$Five_scaled[trait$Cycle == "4"] <- (trait$Five[trait$Cycle == "4"])/max(trait$Five) #[diet$Cycle == "4"]
trait$Five_scaled[trait$Cycle == "3"] <- (trait$Five[trait$Cycle == "3"])/max(trait$Five) #[diet$Cycle == "3"]
trait$Five_scaled[trait$Cycle == "2"] <- (trait$Five[trait$Cycle == "2"])/max(trait$Five) #[diet$Cycle == "2"]
trait$Five_scaled[trait$Cycle == "1"] <- (trait$Five[trait$Cycle == "1"])/max(trait$Five) #[diet$Cycle == "1"]


trait_clean_matrix <- trait[,c("Row.names", "One", "Two", "Three", "Four", "Five", "One_scaled", "Two_scaled", "Three_scaled", "Four_scaled", "Five_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c( "One_scaled", "Two_scaled", "Three_scaled", "Four_scaled", "Five_scaled", "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c( "One_scaled", "Two_scaled", "Three_scaled", "Four_scaled", "Five_scaled","Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_Transparency <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Transparency \n 1 = Opaque \n5 = Transparent") +
  scale_shape_manual(values = c(15, 16, 17, 18, 19, NA), name = "Transparency \n 1 = Opaque \n5 = Transparent") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_Transparency



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyTransparencyCOI.pdf", height =4.8, width = 8.5)
p_Transparency
dev.off()


```

#CALCULATED DVM 
```{r asexual}
traitplot <- COI

#relable empty diet slots as unkown
tax_table(traitplot)[,23][tax_table(traitplot)[,23]==""] <- "Unknown"
tax_table(traitplot)[,23][tax_table(traitplot)[,23]=="Migratory"] <- "Yes"
tax_table(traitplot)[,23][tax_table(traitplot)[,23]=="NonMigratory"] <- "No"


#remove unknowns
nounknowntrait <- subset_taxa(traitplot, CalculatedDVM != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("CalculatedDVM", "Diet")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "CalculatedDVM")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("CalculatedDVM")]
taxa_names(Traitplot_corrmat)
traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$No_scaled <- trait$No
trait$No_scaled[trait$Cycle == "4"] <- (trait$No[trait$Cycle == "4"])/max(trait$No) #[diet$Cycle == "4"]
trait$No_scaled[trait$Cycle == "3"] <- (trait$No[trait$Cycle == "3"])/max(trait$No) #[diet$Cycle == "3"]
trait$No_scaled[trait$Cycle == "2"] <- (trait$No[trait$Cycle == "2"])/max(trait$No) #[diet$Cycle == "2"]
trait$No_scaled[trait$Cycle == "1"] <- (trait$No[trait$Cycle == "1"])/max(trait$No) #[diet$Cycle == "1"]
trait$Yes_scaled <- trait$Yes
trait$Yes_scaled[trait$Cycle == "4"] <- (trait$Yes[trait$Cycle == "4"])/max(trait$Yes) #[diet$Cycle == "4"]
trait$Yes_scaled[trait$Cycle == "3"] <- (trait$Yes[trait$Cycle == "3"])/max(trait$Yes) #[diet$Cycle == "3"]
trait$Yes_scaled[trait$Cycle == "2"] <- (trait$Yes[trait$Cycle == "2"])/max(trait$Yes) #[diet$Cycle == "2"]
trait$Yes_scaled[trait$Cycle == "1"] <- (trait$Yes[trait$Cycle == "1"])/max(trait$Yes) #[diet$Cycle == "1"]



trait_clean_matrix <- trait[,c("Row.names", "No", "Yes", "No_scaled", "Yes_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c("No_scaled", "Yes_scaled",  "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c("No_scaled", "Yes_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_DVM <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "DVM") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "DVM") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_DVM



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyDVMCOI.pdf", height =4.8, width = 8.5)
p_DVM
dev.off()


```

```{r arrange all traits COI}
arrangedtraits <- ggarrange(p_Diet, p_feeding, p_spawning, p_Asexual, p_Carbon, p_Transparency, p_DVM, nrow = 4, ncol = 2, align = "hv")
arrangedtraits



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyAllTraitsCOI.pdf", height =18, width = 14)
arrangedtraits
dev.off()
jpeg(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyAllTraitsCOI.jpeg", height = 18, width = 14, unit = "in", quality = 150, res = 300)
arrangedtraits
dev.off()
```


### ALL TRAITS 18S


#DIET 18s
```{r}
Dietplot <- ZHAN

#relable empty diet slots as unkown
tax_table(Dietplot)[,16][tax_table(Dietplot)[,16]=="NA"] <- NA
tax_table(Dietplot)[,16][is.na(tax_table(Dietplot)[,16])] <- "Unknown"

#remove unknowns
nounknowndiets <- subset_taxa(Dietplot, Diet != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowndiets) <- tax_table(nounknowndiets)[,c("Diet", "FeedingBehavior")]
Dietplot_corrmat <- tax_glom(nounknowndiets)

#rename the gloms to their diet mode
taxa_names(Dietplot_corrmat) <- tax_table(Dietplot_corrmat)[,c("Diet")]
taxa_names(Dietplot_corrmat)
dietsampledat <- data.frame(sample_data(Dietplot_corrmat))
dietdat <- data.frame(otu_table(transform_sample_counts(Dietplot_corrmat, function(x) x / sum(x) )))
diet <- merge(dietsampledat, dietdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
diet$Carnivore_scaled <- diet$Carnivore
diet$Carnivore_scaled[diet$Cycle == "4"] <- (diet$Carnivore[diet$Cycle == "4"])/max(diet$Carnivore) #[diet$Cycle == "4"]
diet$Carnivore_scaled[diet$Cycle == "3"] <- (diet$Carnivore[diet$Cycle == "3"])/max(diet$Carnivore) #[diet$Cycle == "3"]
diet$Carnivore_scaled[diet$Cycle == "2"] <- (diet$Carnivore[diet$Cycle == "2"])/max(diet$Carnivore) #[diet$Cycle == "2"]
diet$Carnivore_scaled[diet$Cycle == "1"] <- (diet$Carnivore[diet$Cycle == "1"])/max(diet$Carnivore) #[diet$Cycle == "1"]
diet$Herbivore_scaled <- diet$Herbivore
diet$Herbivore_scaled[diet$Cycle == "4"] <- (diet$Herbivore[diet$Cycle == "4"])/max(diet$Herbivore) #[diet$Cycle == "4"]
diet$Herbivore_scaled[diet$Cycle == "3"] <- (diet$Herbivore[diet$Cycle == "3"])/max(diet$Herbivore) #[diet$Cycle == "3"]
diet$Herbivore_scaled[diet$Cycle == "2"] <- (diet$Herbivore[diet$Cycle == "2"])/max(diet$Herbivore) #[diet$Cycle == "2"]
diet$Herbivore_scaled[diet$Cycle == "1"] <- (diet$Herbivore[diet$Cycle == "1"])/max(diet$Herbivore) #[diet$Cycle == "1"]
diet$Omnivore_scaled <- diet$Omnivore
diet$Omnivore_scaled[diet$Cycle == "4"] <- (diet$Omnivore[diet$Cycle == "4"])/max(diet$Omnivore) #[diet$Cycle == "4"]
diet$Omnivore_scaled[diet$Cycle == "3"] <- (diet$Omnivore[diet$Cycle == "3"])/max(diet$Omnivore) #[diet$Cycle == "3"]
diet$Omnivore_scaled[diet$Cycle == "2"] <- (diet$Omnivore[diet$Cycle == "2"])/max(diet$Omnivore) #[diet$Cycle == "2"]
diet$Omnivore_scaled[diet$Cycle == "1"] <- (diet$Omnivore[diet$Cycle == "1"])/max(diet$Omnivore) #[diet$Cycle == "1"]


diet_clean_matrix <- diet[,c("Row.names", "Omnivore", "Herbivore", "Carnivore", "Omnivore_scaled", "Herbivore_scaled", "Carnivore_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


```

```{r reformat}

#melt together
melteddiet <- melt(diet_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
melteddiet$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, melteddiet)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c("Omnivore_scaled", "Herbivore_scaled", "Carnivore_scaled", "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c("Carnivore_scaled", "Herbivore_scaled", "Omnivore_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

```

```{r plot pretty diet}

p <- ggplot(data = meltedtogether) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, size = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
  scale_size_manual(values = c(0.8, 0.8, 0.4, 0.4, 0.4), guide = "none") + 
  scale_shape_manual(values =c(16, 16, 16, NA, NA),
                     breaks=c('Carnivore_scaled', 'Herbivore_scaled', 'Omnivore_scaled', 'Fluor_scaled', 'LightExt_scaled'),
                      labels = c("Carnivores", "Herbivores", "Omnivores", "Fluorescence", "Light Exctinction"),
                     guide = "none") + #, guide = "none"
  scale_colour_manual(values = c( "#F8766D", "#619CFF",  "#C77CFF", "#00BA38", "grey1"),
                      breaks=c('Carnivore_scaled', 'Herbivore_scaled', 'Omnivore_scaled', 'Fluor_scaled', 'LightExt_scaled'),
                      labels = c("Carnivores", "Herbivores", "Omnivores", expression(paste("Chlorophyll-",  "\u03B1", sep = "")), "Light Exctinction"),
                      name = "Environmental \nVariable \nDietary Trait") +
  guides(color = guide_legend(override.aes = list(
                         linetype = c("solid", "solid", "solid", "solid", "solid"),
                         shape = c(16, 16, 16, NA,NA)))) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p

meltedtogether_taxa <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_Diet_18S <- ggplot(data = meltedtogether_taxa) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
    scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Diet") +
    scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "Diet") + 
theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_Diet_18S



library(ggh4x) #explore this later if there's time

gp <- ggplotGrob(p)

# optional: take a look at the grob object's layout
gtable::gtable_show_layout(gp)

# get gtable columns corresponding to the facets (5 & 9, in this case)
facet.columns <- gp$layout$l[grepl("panel", gp$layout$name)]
break.columns <- gp$layout$l[grepl("strip", gp$layout$name)]

#facet.columns <- c(5,7,9,11,13,15,17,19)

# get the number of unique x-axis values per facet (1 & 3, in this case)
x.var <- sapply(ggplot_build(p)$layout$panel_scales_x,
                function(l) length(l$range$range))
x.var <- c(1,3,1,3,1,3,1,3)
x.var <- c(1,1,3,3,1,1,3,3,1,1,3,3,1,1,3,3) #change sizes of panels 

b.var <- c(1,1,2,1,2,1,2,1,1,1) #change sizes of breaks

# change the relative widths of the facet columns based on
# how many unique x-axis values are in each facet
gp$widths[facet.columns] <- gp$widths[facet.columns] * x.var
#gp$widths[break.columns] <- gp$widths[break.columns] * b.var

# plot result

grid::grid.draw(gp)

#gt = ggplot_gtable(ggplot_build(gp))
gt <- gp
gt$widths[8] = 3*gt$widths[8]
gt$widths[12] = 3*gt$widths[12]
gt$widths[16] = 3*gt$widths[16]
grid::grid.draw(gt)


pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyDiet18S.pdf", height =4.8, width = 8.5)
grid::grid.draw(gt)
dev.off()

```

```{r play with diet groups (who are each diet), write table}

plot_bar_width_double_withindiet <- function (physeq, x = "Sample", y = "Abundance", 
  title = NULL, facet_grid = NULL, w = "binwidth") {
  mdf = psmelt(physeq)
  disp1 <- max(mdf$Abundance)*1
#  mdf$Abundance[mdf$Diel == "day"] <- mdf$Abundance[mdf$Diel == "day"]*-1
  p <- ggplot(mdf, aes(x = depthmean, y = Abundance, width = binwidth*.9, fill = Order)) + 
    geom_bar(stat = "identity", position ="stack") + #ylim(-disp1, disp1) +
 # scale_y_continuous(breaks = scales::pretty_breaks(n = 4), limits = c(0, disp1)) + 
    theme(axis.text.x = element_text(angle = 90),
          axis.text.y = element_text(angle = 90)) +
 #   scale_color_manual(values = c("lightgrey", "black")) +
    coord_flip() + 
    scale_x_reverse() +
    labs(x = "Depth", y = "Relative Abundance (Proportion)") +
  geom_hline(yintercept = 0, size = 0.2)
  if (!is.null(facet_grid)) {
    p <- p + facet_grid(facet_grid)
  }
  if (!is.null(title)) {
    p <- p + ggtitle(title)
  }
  return(p)
}


p <- plot_bar_width_double_withindiet(transform_sample_counts(subset_taxa(Dietplot, Diet == "Omnivore"), function(x) x / sum(x) ), x = "depthmean") + 
  facet_grid(Diel~Cycle) + 
  theme_bw() +
  theme(strip.text = element_text(size=8),
        plot.subtitle = element_text(size = 9)) + 
 # theme(plot.title = element_text(size=7), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
 # xlab("Rarified Read Count") 
   ggtitle("Omnivores")
p

p <- plot_bar_width_double_withindiet(transform_sample_counts(subset_taxa(Dietplot, Diet == "Carnivore"), function(x) x / sum(x) ), x = "depthmean") + 
  facet_grid(Diel~Cycle) + 
  theme_bw() +
  theme(strip.text = element_text(size=8),
        plot.subtitle = element_text(size = 9)) + 
 # theme(plot.title = element_text(size=7), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
 # xlab("Rarified Read Count") 
   ggtitle("Carnivores")
p


p <- plot_bar_width_double_withindiet(transform_sample_counts(subset_taxa(Dietplot, Diet == "Herbivore"), function(x) x / sum(x) ), x = "depthmean") + 
  facet_grid(Diel~Cycle) + 
  theme_bw() +
  theme(strip.text = element_text(size=8),
        plot.subtitle = element_text(size = 9)) + 
 # theme(plot.title = element_text(size=7), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
 # xlab("Rarified Read Count") 
   ggtitle("Herbivores")
p

dplyr::bind_rows(
  data.frame(tax_table(Dietplot)) %>%
  group_by(Diet, Class) %>% 
  dplyr::summarize(
      OTUs = n(),
      .groups = "drop_last"),
data.frame(tax_table(Dietplot)) %>%
  group_by(Diet, Class, Family) %>% 
  dplyr::summarize(
      OTUs = n(),
      .groups = "drop")) %>%
  arrange(Diet, Class, Family, OTUs) %>%
  gt(rowname_col = NA, groupname_col = "Diet") %>% #rowname_col = "Class", groupname_col = "Diet"
  tab_stubhead(label = "Diet") %>%
  tab_header(
    title = "Diversity within Diet Type",
    subtitle = "Identity and Number of OTUs exhibiting each diet type"
  )%>%
  gtsave(filename = "OTUsbydiet_classfam.docx")



data.frame(tax_table(Dietplot)) %>%
  group_by(Diet, Class, Family) %>% 
  dplyr::summarize(
      OTUs = n(),
      .groups = "drop") %>%
  arrange(Diet, Class, Family, OTUs) %>%
  gt(rowname_col = "Class", groupname_col = "Diet") %>%
  summary_rows(groups = TRUE,
    columns = OTUs,
    fns = list(
      total = "sum")) %>% 
    tab_style(style = cell_text(align = "left", indent = px(80)),
        locations = cells_stub()) %>% 
  tab_header(title = "Diversity within Diet Type",
    subtitle = "Number of OTUs within each Class and Family")%>%
  gtsave(filename = "OTUsbydiet.docx")


data.frame(tax_table(Dietplot)) %>%
  group_by(Diet, Class) %>% 
  dplyr::summarize(
      OTUs = n(),
      .groups = "drop") %>%
  arrange(Diet, Class, OTUs) %>%
  gt(rowname_col = "Class", groupname_col = "Diet") %>%
  summary_rows(groups = TRUE,
    columns = OTUs,
    fns = list(
      total = "sum")) %>% 
    tab_style(style = cell_text(align = "left", indent = px(80)),
        locations = cells_stub()) %>% 
  tab_header(title = "Diversity within Diet Type",
    subtitle = "Number of OTUs within each Class and Family")%>%
  gtsave(filename = "OTUsbydiet_Class.docx")

```

#FEEDING BEHAVIOR _18S
```{r feeding behavior}
traitplot <- ZHAN

#relable empty diet slots as unkown
tax_table(traitplot)[,17][tax_table(traitplot)[,17]==""] <- "Unknown"

#remove unknowns
nounknowntrait <- subset_taxa(traitplot, FeedingBehavior != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("FeedingBehavior", "CalculatedDVM")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "FeedingBehavior")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("FeedingBehavior")]
traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$Suspension_scaled <- trait$Suspension
trait$Suspension_scaled[trait$Cycle == "4"] <- (trait$Suspension[trait$Cycle == "4"])/max(trait$Suspension) #[diet$Cycle == "4"]
trait$Suspension_scaled[trait$Cycle == "3"] <- (trait$Suspension[trait$Cycle == "3"])/max(trait$Suspension) #[diet$Cycle == "3"]
trait$Suspension_scaled[trait$Cycle == "2"] <- (trait$Suspension[trait$Cycle == "2"])/max(trait$Suspension) #[diet$Cycle == "2"]
trait$Suspension_scaled[trait$Cycle == "1"] <- (trait$Suspension[trait$Cycle == "1"])/max(trait$Suspension) #[diet$Cycle == "1"]
trait$Ambush_scaled <- trait$Ambush
trait$Ambush_scaled[trait$Cycle == "4"] <- (trait$Ambush[trait$Cycle == "4"])/max(trait$Ambush) #[diet$Cycle == "4"]
trait$Ambush_scaled[trait$Cycle == "3"] <- (trait$Ambush[trait$Cycle == "3"])/max(trait$Ambush) #[diet$Cycle == "3"]
trait$Ambush_scaled[trait$Cycle == "2"] <- (trait$Ambush[trait$Cycle == "2"])/max(trait$Ambush) #[diet$Cycle == "2"]
trait$Ambush_scaled[trait$Cycle == "1"] <- (trait$Ambush[trait$Cycle == "1"])/max(trait$Ambush) #[diet$Cycle == "1"]
trait$Cruise_scaled <- trait$Cruise
trait$Cruise_scaled[trait$Cycle == "4"] <- (trait$Cruise[trait$Cycle == "4"])/max(trait$Cruise) #[diet$Cycle == "4"]
trait$Cruise_scaled[trait$Cycle == "3"] <- (trait$Cruise[trait$Cycle == "3"])/max(trait$Cruise) #[diet$Cycle == "3"]
trait$Cruise_scaled[trait$Cycle == "2"] <- (trait$Cruise[trait$Cycle == "2"])/max(trait$Cruise) #[diet$Cycle == "2"]
trait$Cruise_scaled[trait$Cycle == "1"] <- (trait$Cruise[trait$Cycle == "1"])/max(trait$Cruise) #[diet$Cycle == "1"]
#trait$Parasitoid_scaled <- trait$Parasitoid
#trait$Parasitoid_scaled[trait$Cycle == "4"] <- (trait$Parasitoid[trait$Cycle == "4"])/max(trait$Parasitoid) #[diet$Cycle == "4"]
#trait$Parasitoid_scaled[trait$Cycle == "3"] <- (trait$Parasitoid[trait$Cycle == "3"])/max(trait$Parasitoid) #[diet$Cycle == "3"]
#trait$Parasitoid_scaled[trait$Cycle == "2"] <- (trait$Parasitoid[trait$Cycle == "2"])/max(trait$Parasitoid) #[diet$Cycle == "2"]
#trait$Parasitoid_scaled[trait$Cycle == "1"] <- (trait$Parasitoid[trait$Cycle == "1"])/max(trait$Parasitoid) #[diet$Cycle == "1"]


trait_clean_matrix <- trait[,c("Row.names", "Suspension", "Ambush", "Cruise", "Suspension_scaled", "Ambush_scaled", "Cruise_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c("Suspension_scaled", "Ambush_scaled", "Cruise_scaled", "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c("Suspension_scaled", "Ambush_scaled", "Cruise_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_feeding_18S <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Feeding Behavior") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "Feeding Behavior") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_feeding_18S



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyFeedBehavior18S.pdf", height =4.8, width = 8.5)
p_feeding_18S
dev.off()


```

#SPAWNING_18S
```{r spawning}
traitplot <- ZHAN

#relable empty diet slots as unkown
tax_table(traitplot)[,18][tax_table(traitplot)[,18]==""] <- "Unknown"

#remove unknowns
nounknowntrait <- subset_taxa(traitplot, Spawning != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("Spawning", "CalculatedDVM")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "Spawning")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("Spawning")]
taxa_names(Traitplot_corrmat)

traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$Broadcast_scaled <- trait$Broadcast
trait$Broadcast_scaled[trait$Cycle == "4"] <- (trait$Broadcast[trait$Cycle == "4"])/max(trait$Broadcast) #[diet$Cycle == "4"]
trait$Broadcast_scaled[trait$Cycle == "3"] <- (trait$Broadcast[trait$Cycle == "3"])/max(trait$Broadcast) #[diet$Cycle == "3"]
trait$Broadcast_scaled[trait$Cycle == "2"] <- (trait$Broadcast[trait$Cycle == "2"])/max(trait$Broadcast) #[diet$Cycle == "2"]
trait$Broadcast_scaled[trait$Cycle == "1"] <- (trait$Broadcast[trait$Cycle == "1"])/max(trait$Broadcast) #[diet$Cycle == "1"]
trait$Brooding_scaled <- trait$Brooding
trait$Brooding_scaled[trait$Cycle == "4"] <- (trait$Brooding[trait$Cycle == "4"])/max(trait$Brooding) #[diet$Cycle == "4"]
trait$Brooding_scaled[trait$Cycle == "3"] <- (trait$Brooding[trait$Cycle == "3"])/max(trait$Brooding) #[diet$Cycle == "3"]
trait$Brooding_scaled[trait$Cycle == "2"] <- (trait$Brooding[trait$Cycle == "2"])/max(trait$Brooding) #[diet$Cycle == "2"]
trait$Brooding_scaled[trait$Cycle == "1"] <- (trait$Brooding[trait$Cycle == "1"])/max(trait$Brooding) #[diet$Cycle == "1"]


trait_clean_matrix <- trait[,c("Row.names", "Broadcast", "Brooding", "Broadcast_scaled", "Brooding_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c("Broadcast_scaled", "Brooding_scaled",  "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c("Broadcast_scaled", "Brooding_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_spawning_18S <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor), name = "Spawning Strategy") + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Spawning Strategy") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA)) + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_spawning_18S



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbySpawn18S.pdf", height =4.8, width = 8.5)
p_spawning_18S
dev.off()


```

#ASEXUAL REPRO_18S
```{r asexual}
traitplot <- ZHAN

#relable empty diet slots as unkown
tax_table(traitplot)[,19][tax_table(traitplot)[,19]==""] <- "Unknown"

#remove unknowns
nounknowntrait <- subset_taxa(traitplot, AsexualRepro != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("AsexualRepro", "CalculatedDVM")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "AsexualRepro")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("AsexualRepro")]
taxa_names(Traitplot_corrmat)
traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$No_scaled <- trait$No
trait$No_scaled[trait$Cycle == "4"] <- (trait$No[trait$Cycle == "4"])/max(trait$No) #[diet$Cycle == "4"]
trait$No_scaled[trait$Cycle == "3"] <- (trait$No[trait$Cycle == "3"])/max(trait$No) #[diet$Cycle == "3"]
trait$No_scaled[trait$Cycle == "2"] <- (trait$No[trait$Cycle == "2"])/max(trait$No) #[diet$Cycle == "2"]
trait$No_scaled[trait$Cycle == "1"] <- (trait$No[trait$Cycle == "1"])/max(trait$No) #[diet$Cycle == "1"]
trait$Yes_scaled <- trait$Yes
trait$Yes_scaled[trait$Cycle == "4"] <- (trait$Yes[trait$Cycle == "4"])/max(trait$Yes) #[diet$Cycle == "4"]
trait$Yes_scaled[trait$Cycle == "3"] <- (trait$Yes[trait$Cycle == "3"])/max(trait$Yes) #[diet$Cycle == "3"]
trait$Yes_scaled[trait$Cycle == "2"] <- (trait$Yes[trait$Cycle == "2"])/max(trait$Yes) #[diet$Cycle == "2"]
trait$Yes_scaled[trait$Cycle == "1"] <- (trait$Yes[trait$Cycle == "1"])/max(trait$Yes) #[diet$Cycle == "1"]



trait_clean_matrix <- trait[,c("Row.names", "No", "Yes", "No_scaled", "Yes_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c("No_scaled", "Yes_scaled",  "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c("No_scaled", "Yes_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_Asexual_18S <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Presence of \nAsexual Reproduction") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "Presence of \nAsexual Reproduction") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_Asexual_18S



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyAsexualRepro18S.pdf", height =4.8, width = 8.5)
p_Asexual_18S
dev.off()


```

#CARBON _18S
```{r carbon}
traitplot <- ZHAN

#relable empty diet slots as unkown
tax_table(traitplot)[,21][tax_table(traitplot)[,21]==""] <- "Unknown"

#remove unknowns
nounknowntrait <- subset_taxa(traitplot, Carbon != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("Carbon", "CalculatedDVM")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "Carbon")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("Carbon")]
taxa_names(Traitplot_corrmat)
traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$G_scaled <- trait$G
trait$G_scaled[trait$Cycle == "4"] <- (trait$G[trait$Cycle == "4"])/max(trait$G) #[diet$Cycle == "4"]
trait$G_scaled[trait$Cycle == "3"] <- (trait$G[trait$Cycle == "3"])/max(trait$G) #[diet$Cycle == "3"]
trait$G_scaled[trait$Cycle == "2"] <- (trait$G[trait$Cycle == "2"])/max(trait$G) #[diet$Cycle == "2"]
trait$G_scaled[trait$Cycle == "1"] <- (trait$G[trait$Cycle == "1"])/max(trait$G) #[diet$Cycle == "1"]
trait$I_scaled <- trait$I
trait$I_scaled[trait$Cycle == "4"] <- (trait$I[trait$Cycle == "4"])/max(trait$I) #[diet$Cycle == "4"]
trait$I_scaled[trait$Cycle == "3"] <- (trait$I[trait$Cycle == "3"])/max(trait$I) #[diet$Cycle == "3"]
trait$I_scaled[trait$Cycle == "2"] <- (trait$I[trait$Cycle == "2"])/max(trait$I) #[diet$Cycle == "2"]
trait$I_scaled[trait$Cycle == "1"] <- (trait$I[trait$Cycle == "1"])/max(trait$I) #[diet$Cycle == "1"]
trait$NG_scaled <- trait$NG
trait$NG_scaled[trait$Cycle == "4"] <- (trait$NG[trait$Cycle == "4"])/max(trait$NG) #[diet$Cycle == "4"]
trait$NG_scaled[trait$Cycle == "3"] <- (trait$NG[trait$Cycle == "3"])/max(trait$NG) #[diet$Cycle == "3"]
trait$NG_scaled[trait$Cycle == "2"] <- (trait$NG[trait$Cycle == "2"])/max(trait$NG) #[diet$Cycle == "2"]
trait$NG_scaled[trait$Cycle == "1"] <- (trait$NG[trait$Cycle == "1"])/max(trait$NG) #[diet$Cycle == "1"]



trait_clean_matrix <- trait[,c("Row.names", "G", "I", "NG", "G_scaled", "I_scaled", "NG_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c( "G_scaled", "I_scaled", "NG_scaled",  "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c( "G_scaled", "I_scaled", "NG_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_Carbon_18S <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Carbon Composition") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "Carbon Composition") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_Carbon_18S



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyCarbon18S.pdf", height =4.8, width = 8.5)
p_Carbon_18S
dev.off()


```

#TRANSPARENCY_18S
```{r}
traitplot <- ZHAN

#relable empty diet slots as unkown
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==""] <- "Unknown"
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==" 1"] <- "One"
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==" 2"] <- "Two"
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==" 3"] <- "Three"
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==" 4"] <- "Four"
tax_table(traitplot)[,22][tax_table(traitplot)[,22]==" 5"] <- "Five"


#remove unknowns
nounknowntrait <- subset_taxa(traitplot, Transparency != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("Transparency", "CalculatedDVM")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "Transparency")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("Transparency")]
taxa_names(Traitplot_corrmat)
traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$One_scaled <- trait$One
trait$One_scaled[trait$Cycle == "4"] <- (trait$One[trait$Cycle == "4"])/max(trait$One) #[diet$Cycle == "4"]
trait$One_scaled[trait$Cycle == "3"] <- (trait$One[trait$Cycle == "3"])/max(trait$One) #[diet$Cycle == "3"]
trait$One_scaled[trait$Cycle == "2"] <- (trait$One[trait$Cycle == "2"])/max(trait$One) #[diet$Cycle == "2"]
trait$One_scaled[trait$Cycle == "1"] <- (trait$One[trait$Cycle == "1"])/max(trait$One) #[diet$Cycle == "1"]
trait$Two_scaled <- trait$Two
trait$Two_scaled[trait$Cycle == "4"] <- (trait$Two[trait$Cycle == "4"])/max(trait$Two) #[diet$Cycle == "4"]
trait$Two_scaled[trait$Cycle == "3"] <- (trait$Two[trait$Cycle == "3"])/max(trait$Two) #[diet$Cycle == "3"]
trait$Two_scaled[trait$Cycle == "2"] <- (trait$Two[trait$Cycle == "2"])/max(trait$Two) #[diet$Cycle == "2"]
trait$Two_scaled[trait$Cycle == "1"] <- (trait$Two[trait$Cycle == "1"])/max(trait$Two) #[diet$Cycle == "1"]
trait$Three_scaled <- trait$Three
trait$Three_scaled[trait$Cycle == "4"] <- (trait$Three[trait$Cycle == "4"])/max(trait$Three) #[diet$Cycle == "4"]
trait$Three_scaled[trait$Cycle == "3"] <- (trait$Three[trait$Cycle == "3"])/max(trait$Three) #[diet$Cycle == "3"]
trait$Three_scaled[trait$Cycle == "2"] <- (trait$Three[trait$Cycle == "2"])/max(trait$Three) #[diet$Cycle == "2"]
trait$Three_scaled[trait$Cycle == "1"] <- (trait$Three[trait$Cycle == "1"])/max(trait$Three) #[diet$Cycle == "1"]
trait$Four_scaled <- trait$Four
trait$Four_scaled[trait$Cycle == "4"] <- (trait$Four[trait$Cycle == "4"])/max(trait$Four) #[diet$Cycle == "4"]
trait$Four_scaled[trait$Cycle == "3"] <- (trait$Four[trait$Cycle == "3"])/max(trait$Four) #[diet$Cycle == "3"]
trait$Four_scaled[trait$Cycle == "2"] <- (trait$Four[trait$Cycle == "2"])/max(trait$Four) #[diet$Cycle == "2"]
trait$Four_scaled[trait$Cycle == "1"] <- (trait$Four[trait$Cycle == "1"])/max(trait$Four) #[diet$Cycle == "1"]
trait$Five_scaled <- trait$Five
trait$Five_scaled[trait$Cycle == "4"] <- (trait$Five[trait$Cycle == "4"])/max(trait$Five) #[diet$Cycle == "4"]
trait$Five_scaled[trait$Cycle == "3"] <- (trait$Five[trait$Cycle == "3"])/max(trait$Five) #[diet$Cycle == "3"]
trait$Five_scaled[trait$Cycle == "2"] <- (trait$Five[trait$Cycle == "2"])/max(trait$Five) #[diet$Cycle == "2"]
trait$Five_scaled[trait$Cycle == "1"] <- (trait$Five[trait$Cycle == "1"])/max(trait$Five) #[diet$Cycle == "1"]


trait_clean_matrix <- trait[,c("Row.names", "One", "Two", "Three", "Four", "Five", "One_scaled", "Two_scaled", "Three_scaled", "Four_scaled", "Five_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c( "One_scaled", "Two_scaled", "Three_scaled", "Four_scaled", "Five_scaled", "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c( "One_scaled", "Two_scaled", "Three_scaled", "Four_scaled", "Five_scaled","Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_Transparency_18S <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "Transparency \n 1 = Opaque \n5 = Transparent") +
  scale_shape_manual(values = c(15, 16, 17, 18, 19, NA), name = "Transparency \n 1 = Opaque \n5 = Transparent") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_Transparency_18S



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyTransparency18S.pdf", height =4.8, width = 8.5)
p_Transparency_18S
dev.off()


```

#CALCULATED DVM _18S
```{r asexual}
traitplot <- ZHAN

#relable empty diet slots as unkown
tax_table(traitplot)[,23][tax_table(traitplot)[,23]==""] <- "Unknown"
tax_table(traitplot)[,23][tax_table(traitplot)[,23]=="Migratory"] <- "Yes"
tax_table(traitplot)[,23][tax_table(traitplot)[,23]=="NonMigratory"] <- "No"


#remove unknowns
nounknowntrait <- subset_taxa(traitplot, CalculatedDVM != "Unknown")

#subset the tax table and glom by trait
tax_table(nounknowntrait) <- tax_table(nounknowntrait)[,c("CalculatedDVM", "Diet")]
Traitplot_corrmat <- tax_glom(nounknowntrait, taxrank = "CalculatedDVM")
taxa_names(Traitplot_corrmat)

#rename the gloms to their diet mode
taxa_names(Traitplot_corrmat) <- tax_table(Traitplot_corrmat)[,c("CalculatedDVM")]
taxa_names(Traitplot_corrmat)
traitsampledat <- data.frame(sample_data(Traitplot_corrmat))
traitdat <- data.frame(otu_table(transform_sample_counts(Traitplot_corrmat, function(x) x / sum(x) )))
trait <- merge(traitsampledat, traitdat, by = 'row.names')


#scale to maximum observed within each type, to look at relative shifts
cyc_avgs$Fluor_scaled <- cyc_avgs$Fluor
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 1])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 2])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 3])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$Fluor_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$Fluor[cyc_avgs$Cycle == 4])/max(cyc_avgs$Fluor[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
cyc_avgs$LightExt_scaled <- cyc_avgs$LightExt
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 1] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 1])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 1]) #[cyc_avgs$Cycle == 1]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 2] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 2])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 2]) #[cyc_avgs$Cycle == 2]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 3] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 3])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 3]) #[cyc_avgs$Cycle == 3]
cyc_avgs$LightExt_scaled[cyc_avgs$Cycle == 4] <- (cyc_avgs$LightExt[cyc_avgs$Cycle == 4])/max(cyc_avgs$LightExt[cyc_avgs$Cycle == 4]) #[cyc_avgs$Cycle == 4]
trait$No_scaled <- trait$No
trait$No_scaled[trait$Cycle == "4"] <- (trait$No[trait$Cycle == "4"])/max(trait$No) #[diet$Cycle == "4"]
trait$No_scaled[trait$Cycle == "3"] <- (trait$No[trait$Cycle == "3"])/max(trait$No) #[diet$Cycle == "3"]
trait$No_scaled[trait$Cycle == "2"] <- (trait$No[trait$Cycle == "2"])/max(trait$No) #[diet$Cycle == "2"]
trait$No_scaled[trait$Cycle == "1"] <- (trait$No[trait$Cycle == "1"])/max(trait$No) #[diet$Cycle == "1"]
trait$Yes_scaled <- trait$Yes
trait$Yes_scaled[trait$Cycle == "4"] <- (trait$Yes[trait$Cycle == "4"])/max(trait$Yes) #[diet$Cycle == "4"]
trait$Yes_scaled[trait$Cycle == "3"] <- (trait$Yes[trait$Cycle == "3"])/max(trait$Yes) #[diet$Cycle == "3"]
trait$Yes_scaled[trait$Cycle == "2"] <- (trait$Yes[trait$Cycle == "2"])/max(trait$Yes) #[diet$Cycle == "2"]
trait$Yes_scaled[trait$Cycle == "1"] <- (trait$Yes[trait$Cycle == "1"])/max(trait$Yes) #[diet$Cycle == "1"]



trait_clean_matrix <- trait[,c("Row.names", "No", "Yes", "No_scaled", "Yes_scaled", "Diel", "Cycle", "Net", "Depth", "depthmean")]


#melt together
meltedtrait <- melt(trait_clean_matrix, id = c("Row.names", "Cycle", "Net", "depthmean", "Diel"))
meltedtrait$facetvar <- "Taxa"

meltedenviro <- melt(cyc_avgs[,c("unique", "Cycle", "Net", "Pressure", "Fluor", "Fluor_scaled", "LightExt", "LightExt_scaled")], id = c("unique", "Cycle", "Net", "Pressure"))
colnames(meltedenviro) <- c("Row.names", "Cycle", "Net", "depthmean", "variable", "value")
meltedenviro <- meltedenviro[meltedenviro$depthmean %in% c(seq(from = 0, to = 400, by = 5)),]
meltedenviro$Diel <- "day"
meltedenviro$facetvar <- "Enviro"
meltedenvironight <- meltedenviro
meltedenvironight$Diel <- "night"

meltedtogether <- rbind(meltedenviro, meltedenvironight)
meltedtogether <- rbind(meltedtogether, meltedtrait)
meltedtogether <- meltedtogether[meltedtogether$variable %in% c("No_scaled", "Yes_scaled",  "Fluor_scaled", "LightExt_scaled"),]
meltedtogether$facetvarunique <- paste(meltedtogether$facetvar, meltedtogether$Cycle)
meltedtogether$facetvarunique_factor <- factor(meltedtogether$facetvarunique, levels = c("Enviro 1", "Taxa 1", "Enviro 2", "Taxa 2", "Enviro 3", "Taxa 3", "Enviro 4", "Taxa 4"))
meltedtogether$variable_factor <- factor(meltedtogether$variable, levels = c("No_scaled", "Yes_scaled", "Fluor_scaled", "LightExt_scaled"))
meltedtogether$value_num <- as.numeric(meltedtogether$value) 


# add grey background
## we only want one box per panel - and only at night - the rest are NA
meltedtogether$shading_min_x <- NA
meltedtogether$shading_max_x <- NA
meltedtogether$shading_min_y <- NA
meltedtogether$shading_max_y <- NA

#add grey background
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_x[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_x[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_min_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(-Inf, rep(NA, length(meltedtogether$shading_min_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[1])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[2])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[3])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[4])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[5])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[6])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[7])])-1))
meltedtogether$shading_max_y[meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8]] <- c(Inf, rep(NA, length(meltedtogether$shading_max_y[(meltedtogether$Diel == "night" & meltedtogether$facetvarunique == unique(meltedtogether$facetvarunique)[8])])-1))

meltedtogether_trait <- meltedtogether[meltedtogether$facetvar == "Taxa",]
p_DVM_18S <- ggplot(data = meltedtogether_trait) + 
  geom_rect(aes(xmin =shading_min_x, xmax = shading_max_x, 
                     ymin =shading_min_y, ymax = shading_max_y), fill = "grey50", alpha = 0.4) +
  geom_line(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor)) + 
  geom_point(aes(y=value_num, x = depthmean, group = variable_factor, color = variable_factor, shape = variable_factor)) + 
  scale_color_manual(values = c("#0000CD", "#CD2626", "#9A32CD", "#FF7F24", "#006400", "#6B6B6B"), name = "DVM") +
  scale_shape_manual(values = c(15, 16, 17, 18, NA, NA), name = "DVM") + 
  theme_bw() + 
  facet_grid(Diel~facetvarunique_factor) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.text.align = 0) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  scale_x_reverse() + 
  coord_flip() + 
  xlab("Depth (m)") + 
  ylab("Proportion of Maximum")  + theme(strip.text = element_blank()) 
p_DVM_18S



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyDVM18S.pdf", height =4.8, width = 8.5)
p_DVM_18S
dev.off()


```


```{r arrange all traits 18s}
arrangedtraits <- ggarrange(p_Diet_18S, p_feeding_18S, p_spawning_18S, p_Asexual_18S, p_Carbon_18S, p_Transparency_18S, p_DVM_18S, nrow = 4, ncol = 2, align = "hv")
arrangedtraits



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyAllTraits18S.pdf", height =18, width = 14)
arrangedtraits
dev.off()
jpeg(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyAllTraits18S.jpeg", height = 18, width = 14, unit = "in", quality = 100, res = 300)
arrangedtraits
dev.off()
```




```{r arrange all traits both}
arrangedtraits <- ggarrange(p_Diet_18S, p_Diet, p_feeding_18S, p_feeding, p_spawning_18S, p_spawning, p_Asexual_18S, p_Asexual, p_Carbon_18S, p_Carbon, p_Transparency_18S, p_Transparency, p_DVM_18S, p_DVM, ncol = 2, nrow = 7,  align = "hv")
arrangedtraits



pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyAllTraits18SandCOI.pdf", height =32, width = 14)
arrangedtraits
dev.off()
jpeg(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyAllTraits18SandCOI.jpeg", height = 32, width = 14, unit = "in", quality = 150, res = 300)
arrangedtraits
dev.off()


arrangeddiet <- ggarrange(p_Diet_18S, p_Diet,  ncol = 2,  align = "hv", common.legend = TRUE, legend = "right")
arrangedfeeding <- ggarrange(p_feeding_18S, p_feeding, ncol = 2, align = "hv", common.legend = TRUE, legend = "right")
arrangedspawning <- ggarrange(p_spawning_18S, p_spawning, ncol = 2, align = "hv", common.legend = TRUE, legend = "right")
arrangedasex <- ggarrange( p_Asexual_18S, p_Asexual,  ncol = 2, align = "hv", common.legend = TRUE, legend = "right")
arrangedcarbon <- ggarrange(p_Carbon_18S, p_Carbon, ncol = 2, align = "hv", common.legend = TRUE, legend = "right")
arrangedtransparency <- ggarrange( p_Transparency_18S, p_Transparency, ncol = 2, align = "hv", common.legend = TRUE, legend = "right")
arrangeddvm <- ggarrange(p_DVM_18S, p_DVM,   ncol = 2, align = "hv", common.legend = TRUE, legend = "right")

arrangedall <- ggarrange(arrangeddiet, arrangedfeeding, arrangedspawning, arrangedasex, arrangedcarbon, arrangedtransparency, arrangeddvm, ncol = 1, align = "hv", common.legend = TRUE)
arrangedall


pdf(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyAllTraits18SandCOIcommonlegends.pdf", height =32, width = 14)
arrangedall
dev.off()
jpeg(file = "~/Documents/Chapter1/for_ms/plots/ASM/VertDistbyAllTraits18SandCOIcommonlegends.jpeg", height = 32, width = 14, unit = "in", quality = 100, res = 300)
arrangedall
dev.off()


```

